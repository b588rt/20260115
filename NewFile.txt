


Sub CopyLatestDetailSheet()

    Dim downloadPath As String
    Dim fileName As String
    Dim latestFile As String
    Dim latestDate As Date
    Dim currentFileDate As Date
    Dim targetPath As String
    Dim wbSource As Workbook
    Dim wbTarget As Workbook
    

    downloadPath = Environ("USERPROFILE") & "\Downloads\"
    targetPath = "E:\0116.xlsm"
    

    fileName = Dir(downloadPath & "*明細*.xls*")
    
 
    If fileName = "" Then
        MsgBox "在下載資料夾中找不到任何的 Excel 檔案。", vbCritical
        Exit Sub
    End If
    
    Do While fileName <> ""
        currentFileDate = FileDateTime(downloadPath & fileName)
        
    
        If currentFileDate > latestDate Then
            latestDate = currentFileDate
            latestFile = fileName
        End If
        
  
        fileName = Dir
    Loop
    
  
    On Error Resume Next
    Set wbTarget = Workbooks("0116.xlsm")
    If wbTarget Is Nothing Then
        If Dir(targetPath) <> "" Then
            Set wbTarget = Workbooks.Open(targetPath)
        Else
            MsgBox "找不到目標檔案： " & targetPath, vbCritical
            Exit Sub
        End If
    End If
    On Error GoTo 0
    
 
    Set wbSource = Workbooks.Open(downloadPath & latestFile)
    
    On Error Resume Next
  
    wbSource.Worksheets("明細").Copy After:=wbTarget.Sheets(wbTarget.Sheets.Count)
    
    If Err.Number <> 0 Then
        MsgBox "檔案「" & latestFile & "」中找不到名為「明細」的工作表。", vbExclamation
    Else
    End If
    On Error GoTo 0
    
 
    wbSource.Close SaveChanges:=False

End Sub

